<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UNO Extreme - Fixed</title>
    <style>
        /* --- CORE STYLES --- */
        body {
            margin: 0; overflow: hidden;
            background: radial-gradient(circle at center, #0f2027, #203a43, #2c5364);
            font-family: 'Arial Black', sans-serif; color: white; height: 100vh;
            user-select: none;
            transition: box-shadow 0.5s ease;
        }

        /* Ambient Glow for Active Color */
        body.red-turn { box-shadow: inset 0 0 150px rgba(255, 0, 0, 0.3); }
        body.blue-turn { box-shadow: inset 0 0 150px rgba(0, 0, 255, 0.3); }
        body.green-turn { box-shadow: inset 0 0 150px rgba(0, 255, 0, 0.3); }
        body.yellow-turn { box-shadow: inset 0 0 150px rgba(255, 215, 0, 0.3); }

        /* SCREENS */
        .screen {
            position: fixed; inset: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.98); z-index: 200;
        }
        .hidden { display: none !important; }

        /* BUTTONS */
        .btn {
            padding: 20px 60px; font-size: 28px; border: none; border-radius: 60px;
            background: linear-gradient(to bottom, #ff512f, #dd2476);
            color: white; cursor: pointer; margin-top: 30px;
            box-shadow: 0 10px 0 #9e1b50; transition: transform 0.1s;
        }
        .btn:active { transform: translateY(5px); box-shadow: none; }
        .btn:disabled { background: #555; box-shadow: none; cursor: not-allowed; opacity: 0.5; }

        /* GAME BOARD */
        #game-ui { display: flex; flex-direction: column; align-items: center; height: 100%; width: 100%; }
        
        #top-bar { margin-top: 20px; text-align: center; }
        #player-name { font-size: 40px; text-transform: uppercase; letter-spacing: 3px; }
        #status-msg { font-size: 18px; color: #aaa; margin-top: 5px; height: 24px;}

        #table {
            display: flex; gap: 100px; align-items: center; justify-content: center;
            flex-grow: 1; margin-bottom: 150px;
        }

        .card-slot {
            width: 140px; height: 200px; border-radius: 14px;
            position: relative;
            background: rgba(255,255,255,0.05);
            border: 2px dashed rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center;
        }

        .card-visual {
            width: 140px; height: 200px; border-radius: 14px;
            background-size: 100% 100%; background-position: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
            background-color: #333; /* Fallback */
        }

        #deck-visual { cursor: pointer; transition: transform 0.2s; }
        #deck-visual:hover { transform: scale(1.05); }
        #deck-visual.locked { filter: grayscale(100%); cursor: not-allowed; opacity: 0.7; }

        /* HAND */
        #hand-wrapper {
            position: fixed; bottom: 40px; width: 100%;
            display: flex; justify-content: center;
            perspective: 1000px;
        }
        #hand { display: flex; align-items: flex-end; height: 220px; }
        .hand-card {
            margin-left: -70px;
            transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform-origin: bottom center;
            cursor: pointer;
        }
        .hand-card:first-child { margin-left: 0; }
        .hand-card:hover { transform: translateY(-70px) scale(1.1) rotate(0deg) !important; z-index: 100; }

        /* ANIMATION */
        #anim-layer { position: fixed; inset: 0; pointer-events: none; z-index: 999; }
        .flying {
            position: absolute; width: 140px; height: 200px;
            border-radius: 14px; background-size: 100% 100%;
            transition: all 0.6s ease-in-out;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        /* MODALS */
        .color-grid { display: flex; gap: 20px; margin-top: 30px; }
        .color-btn { 
            width: 90px; height: 90px; border-radius: 50%; 
            border: 5px solid white; cursor: pointer; transition: transform 0.2s; 
        }
        .color-btn:hover { transform: scale(1.2); }

        #uno-btn {
            position: fixed; right: 40px; bottom: 200px;
            width: 120px; height: 120px; background: #ff9f43;
            border-radius: 50%; border: 4px solid white;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; font-weight: bold; cursor: pointer;
            box-shadow: 0 10px 0 #e67e22; z-index: 150;
            animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }
    </style>
</head>
<body>

    <div id="anim-layer"></div>

    <div id="screen-setup" class="screen">
        <h1 style="font-size: 60px; color: #ff512f; text-shadow: 3px 3px black;">UNO EXTREME</h1>
        <div style="font-size: 20px; margin-bottom: 20px; color: #aaa;">Make sure your images are in the /images folder!</div>
        <button class="btn" onclick="Game.init()">DEAL CARDS</button>
    </div>

    <div id="screen-pass" class="screen hidden">
        <h1 style="font-size: 50px;">NEXT TURN</h1>
        <h2 id="next-player-name" style="color: #4cd137; font-size: 40px;">PLAYER 2</h2>
        <button class="btn" id="start-turn-btn">START TURN</button>
    </div>

    <div id="game-ui" class="hidden">
        <div id="top-bar">
            <div id="player-name">PLAYER 1</div>
            <div id="status-msg">Your Turn</div>
        </div>

        <div id="table">
            <div class="card-slot">
                <div id="deck-visual" class="card-visual" style="background-image: url('images/back.png');"></div>
            </div>
            <div class="card-slot" id="discard-slot">
                </div>
        </div>

        <div id="hand-wrapper">
            <div id="hand"></div>
        </div>

        <div id="uno-btn" class="hidden" onclick="Game.shoutUno()">UNO!</div>
    </div>

    <div id="screen-wild" class="screen hidden">
        <h1>CHOOSE A COLOR</h1>
        <div class="color-grid">
            <div class="color-btn" style="background: #ff5252;" onclick="Game.resolveWild('red')"></div>
            <div class="color-btn" style="background: #448aff;" onclick="Game.resolveWild('blue')"></div>
            <div class="color-btn" style="background: #69f0ae;" onclick="Game.resolveWild('green')"></div>
            <div class="color-btn" style="background: #ffd740;" onclick="Game.resolveWild('yellow')"></div>
        </div>
    </div>

    <script>
        const Game = {
            deck: [],
            players: [[], []],
            turn: 0,
            discard: null,
            isAnimating: false,
            unoCalled: false,

            init: function() {
                this.buildDeck();
                this.shuffle(this.deck);
                
                // Deal 7 cards to each
                this.players = [[], []];
                for(let i=0; i<7; i++) {
                    this.players[0].push(this.deck.pop());
                    this.players[1].push(this.deck.pop());
                }

                // Initial Discard
                this.discard = this.deck.pop();
                while(this.discard.color === 'black') {
                    this.deck.push(this.discard);
                    this.shuffle(this.deck);
                    this.discard = this.deck.pop();
                }

                document.getElementById('screen-setup').classList.add('hidden');
                
                // Setup the Pass Button Listener ONCE
                document.getElementById('start-turn-btn').onclick = () => {
                    document.getElementById('screen-pass').classList.add('hidden');
                    document.getElementById('game-ui').classList.remove('hidden');
                    this.render();
                };

                // Setup Deck Click Listener
                document.getElementById('deck-visual').onclick = () => this.drawCard();

                this.startTurnSequence();
            },

            buildDeck: function() {
                const colors = ['red', 'blue', 'green', 'yellow'];
                this.deck = [];
                colors.forEach(c => {
                    for(let i=0; i<=12; i++) {
                        let val = i;
                        if(i === 10) val = "Skip";
                        if(i === 11) val = "Rev";
                        if(i === 12) val = "+2";
                        
                        // Strict Path Construction
                        let imgPath = `images/${c}${i}.png`;
                        
                        this.deck.push({ color: c, val: val, img: imgPath });
                        if(i !== 0) this.deck.push({ color: c, val: val, img: imgPath });
                    }
                });
                
                // Wilds
                for(let i=0; i<4; i++) {
                    this.deck.push({ color: 'black', val: 13, img: 'images/wild.jpg' });
                    this.deck.push({ color: 'black', val: 14, img: 'images/draw4.jpg' });
                }
            },

            startTurnSequence: function() {
                // Show Pass Screen
                document.getElementById('game-ui').classList.add('hidden');
                document.getElementById('screen-pass').classList.remove('hidden');
                document.getElementById('next-player-name').innerText = `PLAYER ${this.turn + 1}`;
                document.getElementById('next-player-name').style.color = this.turn === 0 ? '#ff5252' : '#448aff';
            },

            render: function() {
                // Update Background Glow
                document.body.className = `${this.discard.color}-turn`;
                
                // Update Text
                document.getElementById('player-name').innerText = `PLAYER ${this.turn + 1}`;
                document.getElementById('status-msg').innerText = "Select a card or draw";

                // Render Discard
                const discardSlot = document.getElementById('discard-slot');
                discardSlot.innerHTML = '';
                discardSlot.appendChild(this.createCardElement(this.discard));

                // Render Hand
                const handEl = document.getElementById('hand');
                handEl.innerHTML = '';
                
                const myHand = this.players[this.turn];
                myHand.forEach((card, index) => {
                    const el = this.createCardElement(card);
                    el.classList.add('hand-card');
                    
                    // Fanning effect
                    let rot = (index - myHand.length/2) * 5; 
                    el.style.transform = `rotate(${rot}deg) translateY(${Math.abs(rot)*2}px)`;

                    el.onclick = () => this.playCard(index, el);
                    handEl.appendChild(el);
                });

                // UNO Button Logic
                if(myHand.length === 2) {
                    document.getElementById('uno-btn').classList.remove('hidden');
                } else {
                    document.getElementById('uno-btn').classList.add('hidden');
                }

                // Unlock Animations
                this.isAnimating = false;
                document.getElementById('deck-visual').classList.remove('locked');
            },

            createCardElement: function(card) {
                const div = document.createElement('div');
                div.className = 'card-visual';
                div.style.backgroundImage = `url('${card.img}')`;
                return div;
            },

            playCard: function(index, el) {
                if(this.isAnimating) return; // PREVENT DOUBLE CLICKS

                const card = this.players[this.turn][index];

                // Validate Move
                if(card.color === 'black' || card.color === this.discard.color || card.val === this.discard.val) {
                    
                    this.isAnimating = true; // LOCK GAME
                    
                    // Visual Animation
                    const startRect = el.getBoundingClientRect();
                    const endRect = document.getElementById('discard-slot').getBoundingClientRect();
                    
                    this.flyCard(startRect, endRect, card.img, () => {
                        // Logic after animation lands
                        this.discard = this.players[this.turn].splice(index, 1)[0];
                        
                        // Check UNO Failure
                        if(this.players[this.turn].length === 1 && !this.unoCalled) {
                            alert("You forgot to say UNO! Draw 2.");
                            this.players[this.turn].push(this.deck.pop(), this.deck.pop());
                        }
                        this.unoCalled = false; // Reset flag

                        // Check Win
                        if(this.players[this.turn].length === 0) {
                            alert(`PLAYER ${this.turn + 1} WINS!`);
                            location.reload();
                            return;
                        }

                        // Handle Logic
                        if(this.discard.color === 'black') {
                            document.getElementById('screen-wild').classList.remove('hidden');
                        } else {
                            this.handleAction(this.discard);
                        }
                    });
                } else {
                    // Shake animation for invalid move
                    el.style.transform += " translateX(10px)";
                    setTimeout(() => el.style.transform = el.style.transform.replace(" translateX(10px)", ""), 200);
                }
            },

            handleAction: function(card) {
                const opponent = (this.turn + 1) % 2;
                
                // 2-PLAYER RULES:
                // Skip / Reverse / +2 / +4 = Current Player plays AGAIN.
                // Standard Wild = Turn passes.
                
                if(card.val === 'Skip' || card.val === 'Rev' || card.val === '+2') {
                    if(card.val === '+2') {
                        // Opponent draws 2
                        this.players[opponent].push(this.deck.pop(), this.deck.pop());
                        alert("Opponent drew 2! Go again.");
                    } else {
                        alert(`${card.val}! Go again.`);
                    }
                    // DO NOT switch turn. Render current player again.
                    this.render();
                } else {
                    // Normal card -> Pass Turn
                    this.turn = opponent;
                    this.startTurnSequence();
                }
            },

            drawCard: function() {
                if(this.isAnimating) return; // Prevent infinite drawing
                this.isAnimating = true;
                document.getElementById('deck-visual').classList.add('locked');

                const card = this.deck.pop();
                
                // Refill deck if empty
                if(this.deck.length === 0) {
                    alert("Reshuffling deck...");
                    location.reload(); // Simple fix for empty deck
                }

                const startRect = document.getElementById('deck-visual').getBoundingClientRect();
                const endRect = { left: window.innerWidth/2, top: window.innerHeight }; // Fly to bottom

                this.flyCard(startRect, endRect, 'images/back.png', () => {
                    this.players[this.turn].push(card);
                    
                    // STANDARD RULE: Draw 1, then pass.
                    // This fixes the "Infinite Draw" bug.
                    this.turn = (this.turn + 1) % 2;
                    this.startTurnSequence();
                });
            },

            resolveWild: function(color) {
                this.discard.color = color;
                document.getElementById('screen-wild').classList.add('hidden');
                
                const opponent = (this.turn + 1) % 2;

                if(this.discard.val === 14) { // Draw 4
                    this.players[opponent].push(this.deck.pop(), this.deck.pop(), this.deck.pop(), this.deck.pop());
                    alert("Opponent drew 4! Go again.");
                    this.render(); // Player keeps turn
                } else {
                    // Standard Wild -> Pass turn
                    this.turn = opponent;
                    this.startTurnSequence();
                }
            },

            shoutUno: function() {
                this.unoCalled = true;
                document.getElementById('uno-btn').classList.add('hidden');
                alert("UNO!!!");
            },

            flyCard: function(from, to, img, callback) {
                const flyer = document.createElement('div');
                flyer.className = 'flying';
                flyer.style.backgroundImage = `url('${img}')`;
                flyer.style.left = from.left + 'px';
                flyer.style.top = from.top + 'px';
                
                document.getElementById('anim-layer').appendChild(flyer);

                // Wait for browser paint
                setTimeout(() => {
                    flyer.style.left = to.left + 'px';
                    flyer.style.top = to.top + 'px';
                    flyer.style.transform = "scale(0.5)";
                }, 10);

                setTimeout(() => {
                    flyer.remove();
                    callback();
                }, 600);
            },

            shuffle: function(a) {
                for (let i = a.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [a[i], a[j]] = [a[j], a[i]];
                }
            }
        };
    </script>
</body>
</html>
