<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNO Animated Pro</title>
    <style>
        /* --- CSS STYLES --- */
        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #1e3c1b, #000000);
            font-family: 'Arial Black', sans-serif;
            color: white;
            height: 100vh;
            user-select: none;
        }

        /* SCREENS */
        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(14, 34, 19, 0.95); z-index: 100; transition: opacity 0.5s;
        }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; }

        /* UI ELEMENTS */
        .btn {
            padding: 15px 40px; font-size: 24px; border: none; border-radius: 50px;
            background: #e74c3c; color: white; cursor: pointer;
            box-shadow: 0 6px 0 #c0392b; transition: 0.1s; margin-top: 20px;
            text-transform: uppercase; letter-spacing: 2px;
        }
        .btn:active { transform: translateY(6px); box-shadow: none; }
        
        input {
            padding: 15px; border-radius: 10px; border: none; 
            text-align: center; font-size: 18px; margin: 10px; width: 200px;
        }

        /* GAME BOARD */
        #game-ui { display: flex; flex-direction: column; align-items: center; height: 100%; width: 100%; }
        #top-bar { margin-top: 20px; text-align: center; }
        #turn-indicator { font-size: 32px; color: #f1c40f; text-shadow: 0 0 10px #f39c12; }
        #message-box { min-height: 30px; margin-top: 5px; font-size: 18px; color: #ecf0f1; }

        #table-area {
            display: flex; gap: 80px; align-items: center; justify-content: center;
            flex-grow: 1; margin-bottom: 50px;
        }

        /* CARDS */
        .card-container {
            width: 120px; height: 170px;
            border-radius: 12px;
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.6);
            cursor: pointer;
            background-size: cover; background-position: center;
            flex-shrink: 0; /* Prevents squashing */
            transition: transform 0.2s;
        }
        /* Number Overlay for Generic Images */
        .card-overlay {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 70px; color: white;
            text-shadow: 3px 3px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
            pointer-events: none;
        }
        .card-corner {
            position: absolute; top: 8px; left: 8px;
            font-size: 24px; text-shadow: 1px 1px 0 #000;
        }
        
        /* HAND */
        #hand-wrapper {
            position: fixed; bottom: 30px; width: 100%;
            display: flex; justify-content: center;
        }
        #hand {
            display: flex; justify-content: center; align-items: flex-end;
            padding: 0 60px;
        }
        .card-container:not(:first-child) { margin-left: -60px; } /* Overlap */
        
        .card-container:hover {
            transform: translateY(-50px) scale(1.15) rotate(2deg);
            z-index: 100;
        }

        /* ANIMATION LAYER */
        #anim-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 9999;
        }
        .flying-card {
            position: absolute; width: 120px; height: 170px; border-radius: 12px;
            background-size: cover; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transition: all 0.6s cubic-bezier(0.19, 1, 0.22, 1);
        }

        /* Color Picker */
        .color-grid { display: flex; gap: 20px; margin-top: 20px; }
        .color-btn { width: 80px; height: 80px; border-radius: 50%; border: 4px solid white; cursor: pointer; transition: 0.2s; }
        .color-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body>

    <div id="anim-layer"></div>

    <div id="setup-screen" class="screen">
        <h1 style="font-size: 60px; color: #e74c3c; text-shadow: 4px 4px #000;">UNO EXTREME</h1>
        <div>
            <input type="text" id="p1-name" placeholder="Player 1 Name" value="Player 1">
            <input type="text" id="p2-name" placeholder="Player 2 Name" value="Player 2">
        </div>
        <button id="start-btn" class="btn">START GAME</button>
    </div>

    <div id="pass-screen" class="screen hidden">
        <h1 id="next-player-msg">READY?</h1>
        <button id="next-turn-btn" class="btn">START TURN</button>
    </div>

    <div id="game-ui" class="hidden">
        <div id="top-bar">
            <div id="turn-indicator">PLAYER 1</div>
            <div id="message-box">Match Color or Number!</div>
        </div>
        
        <div id="table-area">
            <div id="deck" style="cursor: pointer; text-align: center;">
                <img src="images/back.png" class="card-container" style="box-shadow: 0 0 20px gold;">
                <div style="margin-top: 10px; font-weight: bold;">DRAW</div>
            </div>
            
            <div id="discard-pile"></div>
        </div>

        <div id="hand-wrapper">
            <div id="hand"></div>
        </div>
    </div>

    <div id="wild-modal" class="screen hidden" style="background: rgba(0,0,0,0.9);">
        <h2>CHOOSE COLOR</h2>
        <div class="color-grid">
            <div class="color-btn" style="background:#ff5555" data-color="red"></div>
            <div class="color-btn" style="background:#5555ff" data-color="blue"></div>
            <div class="color-btn" style="background:#55aa55" data-color="green"></div>
            <div class="color-btn" style="background:#ffaa00" data-color="yellow"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Game Loaded");

            // --- VARIABLES ---
            let deck = [];
            let players = [[], []];
            let names = ["P1", "P2"];
            let turn = 0;
            let discard = null;
            let isAnimating = false;

            // --- BUTTON LISTENERS ---
            document.getElementById('start-btn').addEventListener('click', startGame);
            document.getElementById('next-turn-btn').addEventListener('click', startTurn);
            document.getElementById('deck').addEventListener('click', handleDraw);
            
            // Wild buttons
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', () => resolveWild(btn.dataset.color));
            });

            // --- CORE FUNCTIONS ---

            function startGame() {
                console.log("Start Clicked");
                names[0] = document.getElementById('p1-name').value || "Player 1";
                names[1] = document.getElementById('p2-name').value || "Player 2";
                
                buildDeck();
                shuffle(deck);
                
                // Deal 7 cards
                players = [[], []];
                for(let i=0; i<7; i++) {
                    players[0].push(deck.pop());
                    players[1].push(deck.pop());
                }
                
                // Discard
                discard = deck.pop();
                while(discard.color === 'black') {
                    deck.push(discard); shuffle(deck); discard = deck.pop();
                }

                document.getElementById('setup-screen').classList.add('hidden');
                prepNextTurn();
            }

            function buildDeck() {
                const colors = ['red', 'blue', 'green', 'yellow'];
                deck = [];
                colors.forEach(c => {
                    for(let i=0; i<=9; i++) {
                        deck.push({ color: c, value: i, img: `${c}.png` });
                        if(i!==0) deck.push({ color: c, value: i, img: `${c}.png` });
                    }
                    ['Skip', 'Rev', '+2'].forEach(act => {
                        deck.push({ color: c, value: act, img: `${c}.png` });
                        deck.push({ color: c, value: act, img: `${c}.png` });
                    });
                });
                for(let i=0; i<4; i++) {
                    deck.push({ color: 'black', value: 'W', img: 'wild.jpg' });
                    deck.push({ color: 'black', value: '+4', img: 'draw4.jpg' });
                }
            }

            function prepNextTurn() {
                document.getElementById('game-ui').classList.add('hidden');
                document.getElementById('pass-screen').classList.remove('hidden');
                document.getElementById('next-player-msg').innerText = `READY ${names[turn]}?`;
            }

            function startTurn() {
                document.getElementById('pass-screen').classList.add('hidden');
                document.getElementById('game-ui').classList.remove('hidden');
                renderBoard();
            }

            function renderBoard() {
                // Update Text
                document.getElementById('turn-indicator').innerText = names[turn].toUpperCase();
                
                // Render Discard
                const pile = document.getElementById('discard-pile');
                pile.innerHTML = '';
                pile.appendChild(createCardHTML(discard));

                // Render Hand
                const handDiv = document.getElementById('hand');
                handDiv.innerHTML = '';
                players[turn].forEach((card, idx) => {
                    const el = createCardHTML(card);
                    el.onclick = () => playCard(idx, el);
                    handDiv.appendChild(el);
                });
            }

            function createCardHTML(card) {
                const div = document.createElement('div');
                div.className = 'card-container';
                div.style.backgroundImage = `url('images/${card.img}')`;
                
                // Add Overlay Number if not special art
                if(card.color !== 'black') {
                    const overlay = document.createElement('div');
                    overlay.className = 'card-overlay';
                    overlay.innerText = card.value;
                    div.appendChild(overlay);

                    const corner = document.createElement('div');
                    corner.className = 'card-corner';
                    corner.innerText = card.value;
                    div.appendChild(corner);
                }
                return div;
            }

            function playCard(index, elem) {
                if(isAnimating) return;
                
                const card = players[turn][index];
                
                // Rules
                if(card.color === 'black' || card.color === discard.color || card.value === discard.value) {
                    isAnimating = true;

                    // ANIMATION: Fly to pile
                    const pileRect = document.getElementById('discard-pile').getBoundingClientRect();
                    animateFly(elem, pileRect, () => {
                        // Logic after landing
                        discard = players[turn].splice(index, 1)[0];
                        
                        if(discard.color === 'black') {
                            document.getElementById('wild-modal').classList.remove('hidden');
                            isAnimating = false; // Wait for input
                        } else {
                            handleAction(discard);
                        }
                    });

                } else {
                    // Invalid Shake
                    elem.style.transform = "translateX(10px)";
                    setTimeout(() => elem.style.transform = "translateX(-10px)", 100);
                    setTimeout(() => elem.style.transform = "translateX(0)", 200);
                    msg("Can't play that!");
                }
            }

            function handleDraw() {
                if(isAnimating) return;
                isAnimating = true;

                const deckRect = document.getElementById('deck').getBoundingClientRect();
                const handRect = document.getElementById('hand').getBoundingClientRect(); // Rough target

                // Visual Animation
                const tempFlyer = document.createElement('div');
                tempFlyer.className = 'flying-card';
                tempFlyer.style.backgroundImage = "url('images/back.png')";
                
                // Start position
                tempFlyer.style.left = deckRect.left + 'px';
                tempFlyer.style.top = deckRect.top + 'px';
                document.getElementById('anim-layer').appendChild(tempFlyer);

                // Move
                setTimeout(() => {
                    tempFlyer.style.left = (window.innerWidth / 2 - 60) + 'px';
                    tempFlyer.style.top = (window.innerHeight - 200) + 'px';
                }, 10);

                setTimeout(() => {
                    tempFlyer.remove();
                    // Actually add card logic
                    const newCard = deck.pop();
                    players[turn].push(newCard);
                    renderBoard();
                    isAnimating = false;
                    
                    if(newCard.color !== 'black' && newCard.color !== discard.color && newCard.value !== discard.value) {
                        msg("No match. Turn ending...");
                        setTimeout(endTurn, 1500);
                    } else {
                        msg("Playable card drawn!");
                    }
                }, 600);
            }

            function handleAction(card) {
                const opponent = (turn + 1) % 2;
                if(card.value === 'Skip' || card.value === 'Rev') {
                    msg("SKIP! Go again.");
                    checkWin();
                    renderBoard();
                    isAnimating = false;
                } else if (card.value === '+2') {
                    msg("Opponent draws 2 & Skips!");
                    players[opponent].push(deck.pop(), deck.pop());
                    checkWin();
                    renderBoard(); // Go again in 2p
                    isAnimating = false;
                } else {
                    checkWin();
                    endTurn();
                }
            }

            function resolveWild(color) {
                discard.color = color;
                document.getElementById('wild-modal').classList.add('hidden');
                
                if(discard.value === '+4') {
                    const opponent = (turn + 1) % 2;
                    players[opponent].push(deck.pop(), deck.pop(), deck.pop(), deck.pop());
                    msg("Opponent draws 4!");
                }
                checkWin();
                endTurn();
            }

            function endTurn() {
                if(players[turn].length === 0) return; // Game over
                isAnimating = false;
                turn = (turn + 1) % 2;
                prepNextTurn();
            }

            function checkWin() {
                if(players[turn].length === 0) {
                    alert(names[turn] + " WINS!");
                    location.reload();
                }
            }

            function animateFly(startElem, endRect, callback) {
                const rect = startElem.getBoundingClientRect();
                const flyer = startElem.cloneNode(true);
                
                // Setup flyer
                flyer.className = 'flying-card';
                flyer.style.margin = 0;
                flyer.style.left = rect.left + 'px';
                flyer.style.top = rect.top + 'px';
                flyer.style.transform = 'none';
                
                document.getElementById('anim-layer').appendChild(flyer);
                startElem.style.opacity = 0; // Hide original

                // Fly
                setTimeout(() => {
                    flyer.style.left = endRect.left + 'px';
                    flyer.style.top = endRect.top + 'px
